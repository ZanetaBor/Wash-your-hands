@page "/mygame"

@using MyApp.Data
@using System.Timers

@inject IJSRuntime JSRuntime;

@inject GameLogic gameLogic;

<h3>Wash your hands</h3>

<button class="btn-secondary m-2" @onclick="StartGame">Start Game</button>

<button class="btn-secondary m-2" @onclick="AddBacteria">Bacterial replication</button>

<button class="btn-secondary m-2" @onclick="Shot">Destruction of bacteria</button>

<button class="btn-secondary m-2" @onclick="WashHands" async>Wash your hands</button>

<button class="btn-secondary m-2" @onclick="DirtyHands">Dirty hands</button> 

<div class="row">
    <div class="col-8">

        <canvas id="backgroundCanvas" width=@gameLogic.Width height=@gameLogic.Height></canvas>
        <canvas id="mainCanvas" width=@gameLogic.Width height=@gameLogic.Height></canvas>

    </div>

    <div class="col-4">

        <div class="card border-secondary p-3 m-2">
            <div class="card-title">
                <h3> Object's positions </h3>
            </div>

            <p>Bacteria</p>
            <ul>
                @foreach (var bacteria in gameLogic.Entities.OfType<Bacteria>())
                {
                    <li> position: (x = @bacteria.PositionX, y = @bacteria.PositionY)</li>
                }
            </ul>

            <hr />
            <p>Medicines</p>
            <ul>
                @foreach (var medicine in gameLogic.Entities.OfType<Medicine>())
                {
                    <li> position: (x = @medicine.PositionX, y = @medicine.PositionY)</li>
                }
            </ul>


        </div>
    </div>

</div>


@code {
    private Timer? gameTimer;

    protected override void OnInitialized()
    {
        gameTimer = new Timer(100);
        gameTimer.Elapsed += async (sender, e) => await UpdateGame();
        base.OnInitialized();
    }

    private void StartGame()
    {
        gameTimer.Start();
    }

    private void AddBacteria()
    {
        gameLogic.CreateBacteria();
    }

    private void Shot()
    {
        gameLogic.CreateMedicine();
    }

    private async Task WashHands()
    {
        gameLogic.CreateObstacle<Soap>();
        await ShowObstacle(gameLogic.Soap);
    }

    private async Task DirtyHands()
    {
        gameLogic.CreateObstacle<Dirty>();
        await ShowObstacle(gameLogic.Dirty);
    }

    private async Task ShowObstacle(Obstacle obstacle)
    {
        while (obstacle?.IsExist == true)
        {
            await DrawObstacle(obstacle);
            await Task.Delay(100); 

            if (obstacle?.IsExist != true)
                break; 
        }

        await ClearObstacle(obstacle);
    }


    private async Task UpdateGame()
    {
        gameLogic.Update();
        await RenderGame();
    }

    private async Task RenderGame()
    {
        var myscript = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./game.js");


        await myscript.InvokeVoidAsync("drawGame", gameLogic.Entities.OfType<Bacteria>(), gameLogic.Entities.OfType<Medicine>());
    }

    private async Task DrawObstacle(Obstacle obstacle)
    {
        var myscript = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./game.js");
        var dto = gameLogic.ToDto(obstacle);
        await myscript.InvokeVoidAsync("drawObstacles", dto);
    }

    private async Task ClearObstacle(Obstacle obstacle)
    { 
        var myscript = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./game.js");
        var dto = gameLogic.ToDto(obstacle);
        await myscript.InvokeVoidAsync("clearObstacle", dto);
    }




}
